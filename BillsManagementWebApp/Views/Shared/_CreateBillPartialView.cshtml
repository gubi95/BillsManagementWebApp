@using BillsManagementWebApp.ViewModels
@using BillsManagementWebApp.Models
@model BillViewModel

@{
    ApplicationDBContext objApplicationDBContext = new ApplicationDBContext();
    List<ProductCategory> listProductCategory = objApplicationDBContext.ProductCategories.ToList();
    string strProductCategoryDropdown = "<select class=\"select-product-category selectpicker\" data-live-search=\"true\">";
    foreach (ProductCategory objProductCategory in listProductCategory)
    {
        strProductCategoryDropdown += "<option value=\"" + objProductCategory.ProductCategoryID + "\">" + objProductCategory.Name + "</option>";
    }
    strProductCategoryDropdown += "</select>";
}

<script>
    var createBillFormValidator = null;

    jQuery(document).ready(function () {
        createBillFormValidator = new Validator('#formCreateBill');         

        jQuery('#dtPurchaseDate').datetimepicker({
            useCurrent: true,
            locale: 'pl',
            format: 'DD.MM.YYYY',
            ignoreReadonly: true
        });

        jQuery('.product-price-selector').TouchSpin({
            verticalbuttons: true,
            verticalupclass: 'glyphicon glyphicon-plus',
            verticaldownclass: 'glyphicon glyphicon-minus',
            min: 0.01,
            max: 1000000.00,
            step: 0.01,
            decimals: 2,
            initval: 1.00,
            postfix: "zł"
        });

        jQuery('.product-quantity-selector').TouchSpin({
            verticalbuttons: true,
            verticalupclass: 'glyphicon glyphicon-plus',
            verticaldownclass: 'glyphicon glyphicon-minus',
            min: 0.01,
            max: 1000000.00,
            step: 0.01,
            decimals: 2,
            initval: 1.00,            
        });

        jQuery('#cbCreateNewShop').iCheck({
            checkboxClass: 'icheckbox_flat-grey',
            radioClass: 'iradio_flat-grey'
        }).on('ifChanged', function (event) {
            var isChecked = jQuery(this).is(':checked');
            if (isChecked) {
                jQuery('#ddlShopSelector').selectpicker('hide');
                jQuery('#txtNewShopName')
                    .attr('data-validators', 'not-empty')
                    .show();
                
            }
            else {
                jQuery('#txtNewShopName').hide();
                RemoveFieldFromValidation(jQuery('#txtNewShopName'));
                jQuery('#ddlShopSelector').selectpicker('show');
            }
        });

        jQuery('body').on('click', '#btn-add-product-row', AddNewProductRow);

        jQuery('body').on('click', '.btn-remove-product-row', function () {
            jQuery(this).closest('.product-row').remove();
        });

        function AddNewProductRow() {
            var productRowHTML =
                '<div class="row product-row" style="padding-bottom: 10px;">' +
                    '<div class="col-md-4" style="padding-top: 4px; padding-left: 40px;">' +
                        '<input type="text" class="form-control" data-validators="not-empty" />' +
                    '</div>' +
                    '<div class="col-md-2" style="padding-top: 4px;">' +
                        '<input type="text" class="product-quantity-selector" style="border-top-left-radius: 4px; border-bottom-left-radius: 4px;" data-validators="not-empty,reg-exp" data-valid-reg-exp="^(?:\\d*((\\.)|(,))\\d{2}|\\d+)$">' +
                    '</div>' +
                    '<div class="col-md-2" style="padding-top: 4px;">' +
                        '<input type="text" class="product-price-selector" style="border-top-left-radius: 4px; border-bottom-left-radius: 4px;" data-validators="not-empty,reg-exp" data-valid-reg-exp="^(?:\\d*((\\.)|(,))\\d{2}|\\d+)$">' +
                    '</div>' +
                    '<div class="col-md-3" style="padding-top: 4px;">' +
                        '@Html.Raw(strProductCategoryDropdown)' +
                    '</div>' +
                    '<div class="col-md-1">' +
                        '<a class="btn btn-default btn-md btn-remove-product-row"><i class="fa fa-times"></i></a>' +
                    '</div>' +
                '</div>';
            jQuery(productRowHTML).insertAfter(jQuery('.product-row').last());

            jQuery(jQuery('.product-price-selector').last()).TouchSpin({
                verticalbuttons: true,
                verticalupclass: 'glyphicon glyphicon-plus',
                verticaldownclass: 'glyphicon glyphicon-minus',
                min: 0.01,
                max: 1000000.00,
                step: 0.01,
                decimals: 2,
                initval: 1.00,
                postfix: "zł"
            });

            jQuery(jQuery('.product-quantity-selector').last()).TouchSpin({
                verticalbuttons: true,
                verticalupclass: 'glyphicon glyphicon-plus',
                verticaldownclass: 'glyphicon glyphicon-minus',
                min: 0.01,
                max: 1000000.00,
                step: 0.01,
                decimals: 2,
                initval: 1.00,                
            });

            jQuery('.select-product-category').last().selectpicker();
        }
    });

    function SaveNewBill() {
        if (!createBillFormValidator.validate(true)) {
            return;
        }

        var objStore = jQuery('#cbCreateNewShop').is(':checked') ?
            {
                StoreID: -1,
                StoreName: jQuery('#txtNewShopName').val().trim()
            } :
            {
                StoreID: jQuery('#ddlShopSelector').selectpicker('val') * 1,  
                StoreName: ''
            };

        var arrProducts = [];
        jQuery('.product-row').each(function () {
            var productName = jQuery(this).find('input[type="text"]').eq(0).val();
            var productQuantity = jQuery(this).find('.product-quantity-selector').val() * 1.00;
            var productPrice = jQuery(this).find('.product-price-selector').val() * 1.00;
            var productCategoryID = jQuery(this).find('.select-product-category').selectpicker('val') * 1;

            arrProducts.push({
                ProductName: productName,
                Quantity: productQuantity,
                Price: productPrice,
                ProductCategoryID: productCategoryID
            });
        });

        var objBill = {
            PurchaseDate: FormatJSDateToCSharpDate(jQuery('#dtPurchaseDate').data("DateTimePicker").date()._d),
            Store: objStore,
            Products: arrProducts
        };

        jQuery.ajax({
            type: 'POST',
            url: '/Handlers/BillHandler.ashx?Action=Create',
            contentType: 'application/json',
            data: JSON.stringify(objBill),
            success: function () {

            },
            error: function () {

            }
        });
    }

</script>

<style>
    .custom-label {
        font-family: Lato;
        color: white;
    }

    #formCreateBill .bootstrap-select {
        width: 100%;
    }

    .btn-transparent {
        min-width: 100px;
        height: 40px;
        background-color: rgba(0,0,0,0);
        border: 1px solid white;
        color: white;
        font-family: Lato;
        text-align: center;
        text-decoration: none;        
        font-size: 14px;
        border-radius: 0;
        -webkit-transition: all 0.20s;
        transition: all 0.20s;
    }

    .btn-transparent:hover {
        background-color: rgba(80,80,80, 0.75) !important;
        color: white !important;       
        border-color: white !important;
    }
</style>

<form id="formCreateBill">
    <div class="row">
        <div class="col-md-2" style="padding-top: 4px;">
            <span class="custom-label">Data zakupów:</span>
        </div>
        <div class="col-md-10">
            <div class='input-group date' id='dtPurchaseDate' style="width: 250px;">
                <input type='text' class="form-control" readonly="readonly" data-validators="not-empty,pl-date" />
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
        </div>
    </div>
    <div class="row" style="padding-top: 10px;">
        <div class="col-md-2" style="padding-top: 4px;">
            <span class="custom-label">Sklep:</span>
        </div>
        <div class="col-md-2" style="padding-top: 7px;">
            <label class="custom-label" for="cbCreateNewShop" style="margin-left: 8px; font-weight: normal;">Nowy sklep</label>
            <div class="iradio checked" style="float: left;">
                <input type="checkbox" id="cbCreateNewShop" checked>
            </div>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="txtNewShopName" style="display: none;" />
            <select class="selectpicker" id="ddlShopSelector" data-live-search="true">
                @{
                    int nCurrentUserID = BillsManagementWebApp.Shared.SessionManager.GetCurrentUser().UserID;
                    List<Shop> listShop = objApplicationDBContext
                        .Shops
                        .Include("UserOwner")
                        .Where(x => x.UserOwner.UserID == nCurrentUserID)
                        .ToList();
                    listShop = listShop.Count == 0 ? new List<Shop>() { new Shop() { ShopID = -1, ShopName = "Brak sklepów" } } : listShop;
                    foreach (Shop objShop in listShop)
                    {
                        <option value="@objShop.ShopID">@objShop.ShopName</option>
                    }
                }
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <h2 style="color: white; font-family: Abel;">Produkty:</h2>
        </div>
    </div>          
    <div class="row">
        <div class="col-md-4" style="padding-top: 4px; padding-left: 40px;">
            <span class="custom-label">Produkt:</span>
        </div>
        <div class="col-md-2" style="padding-top: 4px;">
            <span class="custom-label">Ilość:</span>
        </div>
        <div class="col-md-2" style="padding-top: 4px;">
            <span class="custom-label">Cena całkowita:</span>
        </div>        
        <div class="col-md-3" style="padding-top: 4px;">
            <span class="custom-label">Kategoria:</span>
        </div>
        <div class="col-md-1">
            <span class="custom-label">Usuń:</span>
        </div>
    </div>
    <div class="row product-row" style="padding-bottom: 10px;">
        <div class="col-md-4" style="padding-top: 4px; padding-left: 40px;">
            <input type="text" class="form-control" data-validators="not-empty" />
        </div>
        <div class="col-md-2" style="padding-top: 4px;">
            <input type="text" class="product-quantity-selector" style="border-top-left-radius: 4px; border-bottom-left-radius: 4px;" data-validators="not-empty,reg-exp" data-valid-reg-exp="^(?:\d*((\.)|(,))\d{2}|\d+)$">
        </div>
        <div class="col-md-2" style="padding-top: 4px;">
            <input type="text" class="product-price-selector" style="border-top-left-radius: 4px; border-bottom-left-radius: 4px;" data-validators="not-empty,reg-exp" data-valid-reg-exp="^(?:\d*((\.)|(,))\d{2}|\d+)$">                      
        </div>        
        <div class="col-md-3" style="padding-top: 4px;">
            @Html.Raw(strProductCategoryDropdown)
        </div>
        <div class="col-md-1">
            
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12" style="padding-left: 40px; padding-right: 53px;">
            <a id="btn-add-product-row" class="btn btn-default btn-lg btn-transparent">Dodaj produkt</a>
            <a class="btn btn-default btn-lg btn-transparent" style="float: right;" onclick="SaveNewBill(); return false;">Zapisz</a>
        </div>
    </div>
</form>                    